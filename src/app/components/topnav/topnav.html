<!-- Dynamic Horizontal Menu Bar -->
<div class="horizontal-menu-bar">
  <nav class="menu-nav" role="navigation" aria-label="Main navigation">
    <!-- Generate menu items dynamically from configuration -->
    @if (topNavConfig(); as config) {
      @for (section of config.menuSections; track section.id || $index) {
        <div class="menu-item-container">
          @for (item of section.items; track item.id) {
            <!-- Single menu item without dropdown -->
            @if (!hasChildren(item)) {
              <button 
                mat-button 
                [class.active]="activeMenuTab() === item.id"
                [routerLink]="item.routerLink"
                (click)="onMenuItemClicked(item)"
                (keydown.enter)="onMenuItemClicked(item)"
                (keydown.space)="onMenuItemClicked(item)"
                [attr.aria-label]="item.label"
                [attr.aria-current]="activeMenuTab() === item.id ? 'page' : null"
                class="menu-item">
                <mat-icon [attr.aria-hidden]="true">{{ item.icon }}</mat-icon>
                {{ item.label }}
                @if (item.badge) {
                  <span class="menu-badge" 
                        [ngClass]="'badge-' + item.badge.color"
                        [attr.aria-label]="'Badge: ' + item.badge.text">
                    {{ item.badge.text }}
                  </span>
                }
              </button>
            }

            <!-- Menu item with dropdown (simplified static approach) -->
            @if (hasChildren(item)) {
              @switch (item.id) {
                
                <!-- Resources Menu -->
                @case ('resources-main') {
                <button mat-button 
                        [class.active]="activeMenuTab() === 'resources'" 
                        [matMenuTriggerFor]="resourcesMenu"
                        class="menu-item dropdown">
                  <mat-icon>{{ item.icon }}</mat-icon>
                  {{ item.label }}
                  <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                </button>
                
                  <mat-menu #resourcesMenu="matMenu" class="custom-menu" [overlapTrigger]="false">
                    @for (child of item.children; track child.id; let last = $last) {
                      @if (!hasChildren(child)) {
                        <button 
                          mat-menu-item 
                          [routerLink]="child.routerLink"
                          (click)="onMenuItemClicked(child)">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'resource-management') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="resourceMgmtMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'resource-roles') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="resourceRolesMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (child.dividerAfter && !last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-menu>

                  <!-- Resource Management Submenu -->
                  <mat-menu #resourceMgmtMenu="matMenu" class="custom-submenu">
                    @for (mgmtItem of getChildrenById(item, 'resource-management'); track mgmtItem.id; let last = $last) {
                      <button mat-menu-item (click)="onMenuItemClicked(mgmtItem)">
                        <mat-icon>{{ mgmtItem.icon }}</mat-icon>
                        <span>{{ mgmtItem.label }}</span>
                      </button>
                      @if (mgmtItem.dividerAfter && !last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-menu>

                  <!-- Resource Roles Submenu -->
                  <mat-menu #resourceRolesMenu="matMenu" class="custom-submenu">
                    @for (roleItem of getChildrenById(item, 'resource-roles'); track roleItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(roleItem)">
                        <mat-icon>{{ roleItem.icon }}</mat-icon>
                        <span>{{ roleItem.label }}</span>
                      </button>
                    }
                  </mat-menu>
                }

                <!-- Documents Menu -->
                @case ('documents-main') {
                  <button mat-button 
                          [class.active]="activeMenuTab() === 'documents'" 
                          [matMenuTriggerFor]="documentsMenu"
                          class="menu-item dropdown">
                    <mat-icon>{{ item.icon }}</mat-icon>
                    {{ item.label }}
                    <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                  </button>
                  
                  <mat-menu #documentsMenu="matMenu" class="custom-menu" [overlapTrigger]="false">
                    @for (child of item.children; track child.id; let last = $last) {
                      @if (!hasChildren(child)) {
                        <button 
                          mat-menu-item 
                          [routerLink]="child.routerLink"
                          (click)="onMenuItemClicked(child)">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'financial-reports') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="financialReportsMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'operational-reports') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="operationalReportsMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'custom-reports') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="customReportsMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (child.dividerAfter && !last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-menu>

                  <!-- Financial Reports Submenu -->
                  <mat-menu #financialReportsMenu="matMenu" class="custom-submenu">
                    @for (reportItem of getChildrenById(item, 'financial-reports'); track reportItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(reportItem)">
                        <mat-icon>{{ reportItem.icon }}</mat-icon>
                        <span>{{ reportItem.label }}</span>
                      </button>
                    }
                  </mat-menu>

                  <!-- Operational Reports Submenu -->
                  <mat-menu #operationalReportsMenu="matMenu" class="custom-submenu">
                    @for (reportItem of getChildrenById(item, 'operational-reports'); track reportItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(reportItem)">
                        <mat-icon>{{ reportItem.icon }}</mat-icon>
                        <span>{{ reportItem.label }}</span>
                      </button>
                    }
                  </mat-menu>

                  <!-- Custom Reports Submenu -->
                  <mat-menu #customReportsMenu="matMenu" class="custom-submenu">
                    @for (reportItem of getChildrenById(item, 'custom-reports'); track reportItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(reportItem)">
                        <mat-icon>{{ reportItem.icon }}</mat-icon>
                        <span>{{ reportItem.label }}</span>
                      </button>
                    }
                  </mat-menu>
                }

                <!-- Settings Menu -->
                @case ('settings-main') {
                  <button mat-button 
                          [class.active]="activeMenuTab() === 'settings'" 
                          [matMenuTriggerFor]="settingsMenu"
                          class="menu-item dropdown">
                    <mat-icon>{{ item.icon }}</mat-icon>
                    {{ item.label }}
                    <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                  </button>
                  
                  <mat-menu #settingsMenu="matMenu" class="custom-menu" [overlapTrigger]="false">
                    @for (child of item.children; track child.id; let last = $last) {
                      @if (!hasChildren(child)) {
                        <button 
                          mat-menu-item 
                          [routerLink]="child.routerLink"
                          (click)="onMenuItemClicked(child)">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'system-settings') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="systemSettingsMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'user-preferences') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="userPreferencesMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (hasChildren(child) && child.id === 'security-settings') {
                        <button 
                          mat-menu-item 
                          [matMenuTriggerFor]="securitySettingsMenu">
                          <mat-icon>{{ child.icon }}</mat-icon>
                          <span>{{ child.label }}</span>
                          <mat-icon class="submenu-arrow">arrow_right</mat-icon>
                        </button>
                      }
                      
                      @if (child.dividerAfter && !last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-menu>

                  <!-- System Settings Submenu -->
                  <mat-menu #systemSettingsMenu="matMenu" class="custom-submenu">
                    @for (settingItem of getChildrenById(item, 'system-settings'); track settingItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(settingItem)">
                        <mat-icon>{{ settingItem.icon }}</mat-icon>
                        <span>{{ settingItem.label }}</span>
                      </button>
                    }
                  </mat-menu>

                  <!-- User Preferences Submenu -->
                  <mat-menu #userPreferencesMenu="matMenu" class="custom-submenu">
                    @for (prefItem of getChildrenById(item, 'user-preferences'); track prefItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(prefItem)">
                        <mat-icon>{{ prefItem.icon }}</mat-icon>
                        <span>{{ prefItem.label }}</span>
                      </button>
                    }
                  </mat-menu>

                  <!-- Security Settings Submenu -->
                  <mat-menu #securitySettingsMenu="matMenu" class="custom-submenu">
                    @for (secItem of getChildrenById(item, 'security-settings'); track secItem.id) {
                      <button mat-menu-item (click)="onMenuItemClicked(secItem)">
                        <mat-icon>{{ secItem.icon }}</mat-icon>
                        <span>{{ secItem.label }}</span>
                      </button>
                    }
                  </mat-menu>
                }

                <!-- Other menu items use simplified single level dropdown -->
                @default {
                  <button mat-button 
                          [class.active]="activeMenuTab() === item.id"
                          [matMenuTriggerFor]="defaultMenu"
                          class="menu-item dropdown">
                    <mat-icon>{{ item.icon }}</mat-icon>
                    {{ item.label }}
                    <mat-icon class="dropdown-arrow">arrow_drop_down</mat-icon>
                  </button>
                  
                  <mat-menu #defaultMenu="matMenu" class="custom-menu" [overlapTrigger]="false">
                    @for (child of item.children; track child.id; let last = $last) {
                      <button 
                        mat-menu-item 
                        [routerLink]="child.routerLink"
                        (click)="onMenuItemClicked(child)">
                        <mat-icon>{{ child.icon }}</mat-icon>
                        <span>{{ child.label }}</span>
                      </button>
                      @if (child.dividerAfter && !last) {
                        <mat-divider></mat-divider>
                      }
                    }
                  </mat-menu>
                }
              }
            }
          }
        </div>
      }
    }
  </nav>

  <!-- Dynamic Action Buttons Section -->
  <div class="action-buttons">
    @if (topNavConfig(); as config) {
      <!-- Search Input Field -->
      <div class="search-container" role="search">
        <mat-form-field appearance="outline" class="search-field">
          <input 
            matInput 
            placeholder="Search..." 
            [ngModel]="searchText()" 
            (ngModelChange)="searchText.set($event)" 
            (keyup.enter)="performSearch()"
            aria-label="Search application content"
            aria-describedby="search-description"
            type="search"
            autocomplete="off">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <div id="search-description" class="sr-only">
          Press Enter to search or type to filter results
        </div>
      </div>
      
      <!-- Generate action buttons dynamically -->
      @for (button of config.actionButtons; track button.id) {
        @if (button.id !== 'more') {
          <button 
            mat-icon-button 
            [matTooltip]="button.tooltip" 
            [aria-label]="button.tooltip"
            (click)="onActionButtonClicked(button)">
            <mat-icon>{{ button.icon }}</mat-icon>
            @if (button.badge) {
              <span class="action-badge" [ngClass]="'badge-' + button.badge.color">
                {{ button.badge.text }}
              </span>
            }
          </button>
        }
      }
      
      <!-- More menu button -->
      <button mat-icon-button 
              [matMenuTriggerFor]="moreMenu" 
              matTooltip="More Options"
              aria-label="More options menu">
        <mat-icon>more_vert</mat-icon>
      </button>
      
      <mat-menu #moreMenu="matMenu">
        <button mat-menu-item (click)="openHelp()">
          <mat-icon>help</mat-icon>
          <span>Help & Support</span>
        </button>
        <button mat-menu-item (click)="openNotifications()">
          <mat-icon>notifications</mat-icon>
          <span>Notifications</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="openSettings()">
          <mat-icon>tune</mat-icon>
          <span>System Settings</span>
        </button>
      </mat-menu>
    }
  </div>
</div>
