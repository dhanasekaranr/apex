<div class="page-container">
  <!-- Header Section -->
  <div class="table-header">
    <div class="header-content">
      <mat-icon>people</mat-icon>
      <div class="header-text">
        <h1>User Management</h1>
        <p>Manage system users, roles, and permissions</p>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="table-filters">
    <div class="filter-row">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search Users</mat-label>
        <input matInput 
               [(ngModel)]="filterValue" 
               (keyup)="applyFilter()" 
               placeholder="Search by code, name, or role">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Role</mat-label>
        <mat-select [(value)]="roleFilter" (selectionChange)="applyFilter()">
          <mat-option value="">All Roles</mat-option>
          <mat-option *ngFor="let role of roles" [value]="role">
            {{role}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Status</mat-label>
        <mat-select [(value)]="statusFilter" (selectionChange)="applyFilter()">
          <mat-option value="">All Statuses</mat-option>
          <mat-option *ngFor="let status of statuses" [value]="status">
            {{status}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Debug Mode</mat-label>
        <mat-select [(value)]="debugModeFilter" (selectionChange)="applyFilter()">
          <mat-option value="">All</mat-option>
          <mat-option value="Y">Yes</mat-option>
          <mat-option value="N">No</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-stroked-button (click)="clearFilters()" class="filter-action-btn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>

      <button mat-raised-button color="primary" (click)="addUser()" class="filter-action-btn">
        <mat-icon>person_add</mat-icon>
        Add User
      </button>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="data-table">
          
          <!-- User Code Column -->
          <ng-container matColumnDef="userCode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>User Code</th>
            <td mat-cell *matCellDef="let user">
              <span class="data-code">{{user.userCode}}</span>
            </td>
          </ng-container>

          <!-- User Name Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>User Name</th>
            <td mat-cell *matCellDef="let user">
              <div class="data-info">
                <span class="data-name">{{user.userName}}</span>
              </div>
            </td>
          </ng-container>

          <!-- User Role Column -->
          <ng-container matColumnDef="userRole">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Role</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [color]="getRoleColor(user.userRole)" selected>
                {{user.userRole}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Screen Access Column -->
          <ng-container matColumnDef="screenAccess">
            <th mat-header-cell *matHeaderCellDef>Screen Access</th>
            <td mat-cell *matCellDef="let user">
              <div class="screen-access">
                <mat-chip-set>
                  <mat-chip *ngFor="let screen of user.screenAccess.slice(0, 2)">
                    {{screen}}
                  </mat-chip>
                  <mat-chip *ngIf="user.screenAccess.length > 2" 
                           [matTooltip]="'Click to see all screen access'"
                           (click)="toggleExpandRow(user)"
                           class="expandable-chip">
                    +{{user.screenAccess.length - 2}} more
                  </mat-chip>
                </mat-chip-set>
              </div>
            </td>
          </ng-container>

          <!-- Dual Mode Column -->
          <ng-container matColumnDef="dualMode">
            <th mat-header-cell *matHeaderCellDef>Dual Mode</th>
            <td mat-cell *matCellDef="let user">
              <mat-checkbox 
                [checked]="user.dualMode" 
                (change)="toggleDualMode(user)"
                [color]="'primary'">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Debug Mode Column -->
          <ng-container matColumnDef="debugMode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Debug Mode</th>
            <td mat-cell *matCellDef="let user">
              <mat-checkbox 
                [checked]="user.debugMode === 'Y'" 
                (change)="updateDebugMode(user, $event.checked ? 'Y' : 'N')"
                [color]="'accent'">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Last Login Column -->
          <ng-container matColumnDef="lastLogin">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Login</th>
            <td mat-cell *matCellDef="let user">
              <span class="last-login">{{user.lastLogin | date:'short'}}</span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [color]="getStatusColor(user.status)" selected>
                {{user.status}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let user">
              <div class="action-buttons">
                <button mat-icon-button 
                        (click)="editUser(user)" 
                        matTooltip="Edit User"
                        color="primary">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="deleteUser(user)" 
                        matTooltip="Delete User"
                        color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          
          <!-- Regular data rows with potential detail rows -->
          <ng-container *matRowDef="let row; columns: displayedColumns; let i = index">
            <tr mat-row class="data-row" [class.expanded-row]="isExpanded(row)"></tr>
            
            <!-- Detail row immediately after each main row -->
            <tr *ngIf="isExpanded(row)" class="detail-row">
              <td [attr.colspan]="displayedColumns.length" class="detail-cell">
                <div class="detail-container">
                  <div class="detail-content">
                    <div class="detail-header">
                      <h3>
                        <mat-icon>person</mat-icon>
                        {{row.userName}} - Detailed Information
                      </h3>
                      <button mat-icon-button (click)="toggleExpandRow(row)" class="close-detail-btn">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                    
                    <div class="detail-section">
                      <h4><mat-icon>security</mat-icon> Complete Screen Access ({{row.screenAccess.length}} screens)</h4>
                      <div class="detail-chips">
                        <mat-chip-set>
                          <mat-chip *ngFor="let screen of row.screenAccess" 
                                    [color]="'primary'"
                                    selected>
                            {{screen}}
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </div>
                    
                    <div class="detail-section">
                      <h4><mat-icon>info</mat-icon> User Details</h4>
                      <div class="detail-grid">
                        <div class="detail-item">
                          <span class="detail-label">User ID:</span>
                          <span class="detail-value">{{row.id}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">User Code:</span>
                          <span class="detail-value code-detail">{{row.userCode}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Role:</span>
                          <span class="detail-value">
                            <mat-chip [color]="getRoleColor(row.userRole)" selected>
                              {{row.userRole}}
                            </mat-chip>
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Dual Mode:</span>
                          <span class="detail-value">
                            <mat-icon [color]="row.dualMode ? 'primary' : ''" 
                                      class="status-icon">
                              {{row.dualMode ? 'check_circle' : 'cancel'}}
                            </mat-icon>
                            {{row.dualMode ? 'Enabled' : 'Disabled'}}
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Debug Mode:</span>
                          <span class="detail-value">
                            <mat-icon [color]="row.debugMode === 'Y' ? 'accent' : ''" 
                                      class="status-icon">
                              {{row.debugMode === 'Y' ? 'bug_report' : 'bug_report_off'}}
                            </mat-icon>
                            {{row.debugMode === 'Y' ? 'Active' : 'Inactive'}}
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Status:</span>
                          <span class="detail-value">
                            <mat-chip [color]="getStatusColor(row.status)" selected>
                              {{row.status}}
                            </mat-chip>
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Last Login:</span>
                          <span class="detail-value">{{row.lastLogin | date:'full'}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Total Screen Access:</span>
                          <span class="detail-value">{{row.screenAccess.length}} screens</span>
                        </div>
                      </div>
                    </div>

                    <div class="detail-actions">
                      <button mat-raised-button color="primary" (click)="editUser(row)">
                        <mat-icon>edit</mat-icon>
                        Edit User
                      </button>
                      <button mat-stroked-button (click)="toggleExpandRow(row)">
                        <mat-icon>keyboard_arrow_up</mat-icon>
                        Collapse
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </table>

        <!-- No Data Message -->
        <div *ngIf="dataSource.filteredData.length === 0" class="no-data">
          <mat-icon>people_outline</mat-icon>
          <p>No users found matching your criteria</p>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator 
        [pageSizeOptions]="[5, 10, 20, 50]" 
        [pageSize]="10"
        showFirstLastButtons>
      </mat-paginator>
</div>
