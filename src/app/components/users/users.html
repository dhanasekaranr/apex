<div class="page-container">
  <!-- Header Section -->
  <div class="table-header">
    <div class="header-content">
      <mat-icon>people</mat-icon>
      <div class="header-text">
        <h1>User Management</h1>
        <p>Manage system users, roles, and permissions</p>
      </div>
      @if (loading()) {
        <mat-icon class="loading-icon" 
                  aria-label="Loading users" 
                  role="status">refresh</mat-icon>
      }
    </div>
  </div>

  <!-- Error Display -->
  @if (error(); as errorMsg) {
    <div class="error-banner">
      <mat-icon>error</mat-icon>
      <span>{{ errorMsg }}</span>
      <button mat-icon-button 
              (click)="clearError()"
              aria-label="Clear error message"
              title="Clear error message">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  <!-- Filters Section -->
  <div class="table-filters" role="search" aria-label="User search and filters">
    <div class="filter-row">
      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Search Users</mat-label>
          <input matInput 
                 [(ngModel)]="filterValue" 
                 (keyup)="applyFilter()" 
                 placeholder="Search by code, name, or role"
                 aria-label="Search users by code, name, or role"
                 aria-describedby="search-help">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <span id="search-help" class="sr-only">Type to filter users by user code, name, or role</span>
      </div>

      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filter by Role</mat-label>
          <mat-select [(value)]="roleFilter" 
                      (selectionChange)="applyFilter()"
                      aria-label="Filter users by role"
                      aria-describedby="role-filter-help">
            <mat-option value="">All Roles</mat-option>
            <mat-option *ngFor="let role of roles" [value]="role">
              {{role}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <span id="role-filter-help" class="sr-only">Select a role to filter the user list</span>
      </div>

      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Filter by Status</mat-label>
          <mat-select [(value)]="statusFilter" 
                      (selectionChange)="applyFilter()"
                      aria-label="Filter users by status"
                      aria-describedby="status-filter-help">
            <mat-option value="">All Statuses</mat-option>
            <mat-option *ngFor="let status of statuses" [value]="status">
              {{status}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <span id="status-filter-help" class="sr-only">Select a status to filter the user list</span>
      </div>

      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Debug Mode</mat-label>
          <mat-select [(value)]="debugModeFilter" 
                      (selectionChange)="applyFilter()"
                      aria-label="Filter users by debug mode"
                      aria-describedby="debug-filter-help">
            <mat-option value="">All</mat-option>
            <mat-option value="Y">Yes</mat-option>
            <mat-option value="N">No</mat-option>
          </mat-select>
        </mat-form-field>
        <span id="debug-filter-help" class="sr-only">Select debug mode status to filter the user list</span>
      </div>

      <button mat-stroked-button 
              (click)="clearFilters()" 
              class="filter-action-btn"
              aria-label="Clear all user filters"
              title="Clear all applied filters">
        <mat-icon aria-hidden="true">clear</mat-icon>
        Clear Filters
      </button>

      <button mat-raised-button 
              color="primary" 
              (click)="addUser()" 
              class="filter-action-btn"
              aria-label="Add new user to the system"
              title="Add new user">
        <mat-icon aria-hidden="true">person_add</mat-icon>
        Add User
      </button>
    </div>
  </div>

  <!-- Table Section -->
  <div class="table-container" role="region" aria-label="Users data table">
        <table mat-table 
               [dataSource]="dataSource" 
               matSort 
               class="data-table"
               role="table"
               aria-label="Users data table"
               [attr.aria-rowcount]="dataSource.data.length + 1">
          
          <!-- User Code Column -->
          <ng-container matColumnDef="userCode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">User Code</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <span class="data-code">{{user.userCode}}</span>
            </td>
          </ng-container>

          <!-- User Name Column -->
          <ng-container matColumnDef="userName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">User Name</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <div class="data-info">
                <span class="data-name">{{user.userName}}</span>
              </div>
            </td>
          </ng-container>

          <!-- User Role Column -->
          <ng-container matColumnDef="userRole">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">Role</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <mat-chip [color]="getRoleColor(user.userRole)" selected>
                {{user.userRole}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Screen Access Column -->
          <ng-container matColumnDef="screenAccess">
            <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Screen Access</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <div class="screen-access">
                <mat-chip-set>
                  <mat-chip *ngFor="let screen of user.screenAccess.slice(0, 2)">
                    {{screen}}
                  </mat-chip>
                  <mat-chip *ngIf="user.screenAccess.length > 2" 
                           [matTooltip]="'Click to see all screen access'"
                           (click)="toggleExpandRow(user)"
                           (keydown.enter)="toggleExpandRow(user)"
                           (keydown.space)="toggleExpandRow(user)"
                           class="expandable-chip"
                           [attr.aria-label]="'Show ' + (user.screenAccess.length - 2) + ' more screens for ' + user.userName"
                           tabindex="0"
                           role="button">
                    +{{user.screenAccess.length - 2}} more
                  </mat-chip>
                </mat-chip-set>
              </div>
            </td>
          </ng-container>

          <!-- Dual Mode Column -->
          <ng-container matColumnDef="dualMode">
            <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Dual Mode</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <mat-checkbox 
                [checked]="user.dualMode" 
                (change)="toggleDualMode(user)"
                [color]="'primary'"
                [ariaLabel]="'Toggle dual mode for ' + user.userName">
                Dual Mode
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Debug Mode Column -->
          <ng-container matColumnDef="debugMode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">Debug Mode</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <mat-checkbox 
                [checked]="user.debugMode === 'Y'" 
                (change)="updateDebugMode(user, $event.checked ? 'Y' : 'N')"
                [color]="'accent'"
                [ariaLabel]="'Toggle debug mode for ' + user.userName">
                Debug Mode
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Last Login Column -->
          <ng-container matColumnDef="lastLogin">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">Last Login</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <span class="last-login">{{user.lastLogin | date:'short'}}</span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header role="columnheader" scope="col">Status</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <mat-chip [color]="getStatusColor(user.status)" selected>
                {{user.status}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef role="columnheader" scope="col">Actions</th>
            <td mat-cell *matCellDef="let user" role="gridcell">
              <div class="action-buttons">
                <button mat-icon-button 
                        (click)="editUser(user)" 
                        matTooltip="Edit User"
                        [aria-label]="'Edit user ' + user.userName"
                        [title]="'Edit user ' + user.userName"
                        color="primary">
                  <mat-icon aria-hidden="true">edit</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="deleteUser(user)" 
                        matTooltip="Delete User"
                        [aria-label]="'Delete user ' + user.userName"
                        [title]="'Delete user ' + user.userName"
                        color="warn">
                  <mat-icon aria-hidden="true">delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns" role="row"></tr>
          
          <!-- Regular data rows with potential detail rows -->
          <ng-container *matRowDef="let row; columns: displayedColumns; let i = index">
            <tr mat-row class="data-row" [class.expanded-row]="isExpanded(row)" role="row" [attr.aria-rowindex]="i + 2"></tr>
            
            <!-- Detail row immediately after each main row -->
            <tr *ngIf="isExpanded(row)" 
                class="detail-row" 
                role="row" 
                [id]="'detail-' + row.id"
                [attr.aria-label]="'Expanded details for ' + row.userName">
              <td [attr.colspan]="displayedColumns.length" class="detail-cell" role="gridcell">
                <div class="detail-container">
                  <div class="detail-content">
                    <div class="detail-header">
                      <h3>
                        <mat-icon>person</mat-icon>
                        {{row.userName}} - Detailed Information
                      </h3>
                      <button mat-icon-button 
                              (click)="toggleExpandRow(row)" 
                              class="close-detail-btn"
                              [aria-label]="'Close details for ' + row.userName"
                              [title]="'Close details for ' + row.userName">
                        <mat-icon aria-hidden="true">close</mat-icon>
                      </button>
                    </div>
                    
                    <div class="detail-section">
                      <h4><mat-icon>security</mat-icon> Complete Screen Access ({{row.screenAccess.length}} screens)</h4>
                      <div class="detail-chips">
                        <mat-chip-set>
                          <mat-chip *ngFor="let screen of row.screenAccess" 
                                    [color]="'primary'"
                                    selected>
                            {{screen}}
                          </mat-chip>
                        </mat-chip-set>
                      </div>
                    </div>
                    
                    <div class="detail-section">
                      <h4><mat-icon>info</mat-icon> User Details</h4>
                      <div class="detail-grid">
                        <div class="detail-item">
                          <span class="detail-label">User ID:</span>
                          <span class="detail-value">{{row.id}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">User Code:</span>
                          <span class="detail-value code-detail">{{row.userCode}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Role:</span>
                          <span class="detail-value">
                            <mat-chip [color]="getRoleColor(row.userRole)" selected>
                              {{row.userRole}}
                            </mat-chip>
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Dual Mode:</span>
                          <span class="detail-value">
                            <mat-icon [color]="row.dualMode ? 'primary' : ''" 
                                      class="status-icon">
                              {{row.dualMode ? 'check_circle' : 'cancel'}}
                            </mat-icon>
                            {{row.dualMode ? 'Enabled' : 'Disabled'}}
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Debug Mode:</span>
                          <span class="detail-value">
                            <mat-icon [color]="row.debugMode === 'Y' ? 'accent' : ''" 
                                      class="status-icon">
                              {{row.debugMode === 'Y' ? 'bug_report' : 'bug_report_off'}}
                            </mat-icon>
                            {{row.debugMode === 'Y' ? 'Active' : 'Inactive'}}
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Status:</span>
                          <span class="detail-value">
                            <mat-chip [color]="getStatusColor(row.status)" selected>
                              {{row.status}}
                            </mat-chip>
                          </span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Last Login:</span>
                          <span class="detail-value">{{row.lastLogin | date:'full'}}</span>
                        </div>
                        <div class="detail-item">
                          <span class="detail-label">Total Screen Access:</span>
                          <span class="detail-value">{{row.screenAccess.length}} screens</span>
                        </div>
                      </div>
                    </div>

                    <div class="detail-actions">
                      <button mat-raised-button 
                              color="primary" 
                              (click)="editUser(row)"
                              [aria-label]="'Edit user ' + row.userName"
                              [title]="'Edit user ' + row.userName">
                        <mat-icon aria-hidden="true">edit</mat-icon>
                        Edit User
                      </button>
                      <button mat-stroked-button 
                              (click)="toggleExpandRow(row)"
                              [aria-label]="'Collapse details for ' + row.userName"
                              [title]="'Collapse details for ' + row.userName">
                        <mat-icon aria-hidden="true">keyboard_arrow_up</mat-icon>
                        Collapse
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </table>

        <!-- No Data Message -->
        <div *ngIf="dataSource.filteredData.length === 0" 
             class="no-data"
             role="status"
             aria-live="polite"
             aria-label="No users found">
          <mat-icon aria-hidden="true">people_outline</mat-icon>
          <p>No users found matching your criteria</p>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator 
        [pageSizeOptions]="[5, 10, 20, 50]" 
        [pageSize]="10"
        showFirstLastButtons
        aria-label="User table pagination controls">
      </mat-paginator>
</div>
