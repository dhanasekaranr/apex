<div class="page-container">
  <div class="page-header">
    <div class="header-content">
      <div class="title-container">
        <h1 class="page-title">Lookup Management</h1>
        <button 
          mat-icon-button 
          class="page-help-button"
          popoverTrigger="Lookup Management allows you to maintain system reference data used throughout the application.

Key Features:
• View and edit lookup tables (e.g., status codes, categories)
• Add, modify, or remove lookup values
• Control which values are active/inactive
• Organize data with keys, display values, and descriptions

How to Use:
1. Select a lookup table from the left panel
2. Edit values directly in the table on the right
3. Use the help icons for field-specific guidance
4. Save changes when done

Note: Changes affect how data appears throughout the system, so please review carefully before saving."
          [popoverConfig]="{ 
            trigger: 'click', 
            placement: 'bottom-start', 
            showHeader: true, 
            headerText: 'About Lookup Management',
            showCopy: false,
            maxWidth: '450px'
          }"
          aria-label="About lookup management">
          <mat-icon class="help-icon">info_outline</mat-icon>
        </button>
      </div>
      <p class="page-subtitle">Manage system lookup tables and reference data</p>
      @if (loading()) {
        <mat-icon class="loading-icon">refresh</mat-icon>
      }
    </div>
  </div>

  <!-- Error Display -->
  @if (error(); as errorMsg) {
    <div class="error-banner">
      <mat-icon>error</mat-icon>
      <span>{{ errorMsg }}</span>
      <button mat-icon-button 
              (click)="clearError()"
              aria-label="Clear error message"
              title="Clear error message">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  }

  <div class="two-panel-container">
    <!-- Left Column - Data List Panel -->
    <div class="left-panel data-list-panel">
      <mat-card class="content-card">
        <mat-card-header>
          <mat-card-title>Lookup Tables</mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <!-- Search Bar -->
          <div class="search-bar-container">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Search lookups...</mat-label>
              <input 
                matInput 
                [(ngModel)]="searchTerm" 
                (ngModelChange)="onSearchChange()"
                placeholder="Search by name, description, or category">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            <button 
              mat-icon-button 
              class="search-help-button"
              popoverTrigger="Search Tips:
• Type any part of the lookup name
• Search by category (e.g., 'status', 'type')
• Use partial matches for quick filtering
• Clear the field to see all lookups

Examples:
• 'status' - finds all status-related lookups
• 'user' - finds user-related tables
• 'active' - finds items containing 'active'"
              [popoverConfig]="{ 
                trigger: 'click', 
                placement: 'bottom-start', 
                showHeader: true, 
                headerText: 'Search Help'
              }"
              aria-label="Search help">
              <mat-icon class="help-icon">help_outline</mat-icon>
            </button>
          </div>

          <!-- Data List -->
          <mat-nav-list class="data-list">
            @for (lookup of filteredLookups; track lookup.id) {
              <mat-list-item 
                [class.selected]="selectedLookup()?.id === lookup.id"
                (click)="selectLookup(lookup)">
                <div matListItemTitle>{{ lookup.name }}</div>
                <div matListItemMeta class="data-category">{{ lookup.category }}</div>
              </mat-list-item>
            }
          </mat-nav-list>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Right Column - Data Details Panel -->
    <div class="right-panel data-details-panel">
      @if (selectedLookup(); as selectedItem) {
      <mat-card class="content-card">
        <mat-card-header>
          <mat-card-title>{{ selectedItem.name }}</mat-card-title>
          <mat-card-subtitle>{{ selectedItem.description }}</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <!-- Data Info -->
          <div class="data-info">
            <div class="info-row">
              <span class="info-label">Category:</span>
              <span class="info-value">{{ selectedItem.category }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Total Values:</span>
              <span class="info-value">{{ selectedItem.values.length }}</span>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button mat-raised-button class="action-button-primary" (click)="addNewValue()">
              <mat-icon>add</mat-icon>
              Add Value
            </button>
            <button mat-raised-button class="action-button-accent" (click)="saveLookup()">
              <mat-icon>save</mat-icon>
              Save Changes
            </button>
          </div>

          <!-- Data Table -->
          <div class="data-table-container">
            <table mat-table [dataSource]="selectedItem.values" class="data-table">
              <!-- Key Column -->
              <ng-container matColumnDef="key">
                <th mat-header-cell *matHeaderCellDef>
                  Key
                  <button 
                    mat-icon-button 
                    class="help-button"
                    popoverTrigger="The unique identifier for this lookup value. This should be:
• Short and memorable
• Use underscores instead of spaces (e.g., 'active_status')
• Follow consistent naming conventions
• Be unique within this lookup table

Examples: 'pending', 'approved', 'rejected'"
                    [popoverConfig]="{ 
                      trigger: 'click', 
                      placement: 'top', 
                      showHeader: true, 
                      headerText: 'Key Field Help',
                      showCopy: true,
                      role: 'tooltip'
                    }"
                    aria-label="Help for key field">
                    <mat-icon class="help-icon">help_outline</mat-icon>
                  </button>
                </th>
                <td mat-cell *matCellDef="let value; let i = index">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput [(ngModel)]="value.key" placeholder="Enter key">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Value Column -->
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef>
                  Display Value
                  <button 
                    mat-icon-button 
                    class="help-button"
                    popoverTrigger="The human-readable text that users will see in the application. This should be:
• Clear and descriptive
• User-friendly language
• Properly capitalized
• Meaningful to end users

The display value can be different from the key. For example:
• Key: 'pending_review' → Display Value: 'Pending Review'
• Key: 'active' → Display Value: 'Active Status'"
                    [popoverConfig]="{ 
                      trigger: 'click', 
                      placement: 'top', 
                      showHeader: true, 
                      headerText: 'Display Value Help',
                      showCopy: true,
                      role: 'tooltip'
                    }"
                    aria-label="Help for display value field">
                    <mat-icon class="help-icon">help_outline</mat-icon>
                  </button>
                </th>
                <td mat-cell *matCellDef="let value; let i = index">
                  <mat-form-field appearance="outline" class="table-input">
                    <input matInput [(ngModel)]="value.value" placeholder="Enter display value">
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Description Column -->
              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>
                  Description
                  <button 
                    mat-icon-button 
                    class="help-button"
                    popoverTrigger="Optional detailed explanation of what this lookup value represents. Use this to:
• Provide additional context for developers
• Explain business rules or conditions
• Document when this value should be used
• Add any special notes or warnings

This field is typically used for:
• Internal documentation
• Developer reference
• Business context that isn't obvious from the display value"
                    [popoverConfig]="{ 
                      trigger: 'click', 
                      placement: 'top', 
                      showHeader: true, 
                      headerText: 'Description Field Help',
                      showCopy: true,
                      role: 'tooltip'
                    }"
                    aria-label="Help for description field">
                    <mat-icon class="help-icon">help_outline</mat-icon>
                  </button>
                </th>
                <td mat-cell *matCellDef="let value; let i = index">
                  <mat-form-field appearance="outline" class="table-input">
                    <input 
                      matInput 
                      [(ngModel)]="value.description" 
                      placeholder="Enter description" />
                  </mat-form-field>
                </td>
              </ng-container>

              <!-- Active Status Column -->
              <ng-container matColumnDef="isActive">
                <th mat-header-cell *matHeaderCellDef>Active</th>
                <td mat-cell *matCellDef="let value">
                  <button 
                    mat-icon-button 
                    [color]="value.isActive ? 'primary' : ''"
                    (click)="toggleValueStatus(value)"
                    [title]="value.isActive ? 'Active' : 'Inactive'"
                    [aria-label]="'Toggle active status for ' + value.name">
                    <mat-icon>{{ value.isActive ? 'check_circle' : 'cancel' }}</mat-icon>
                  </button>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let value; let i = index">
                  <button 
                    mat-icon-button 
                    color="warn" 
                    (click)="removeValue(i)"
                    title="Remove this value"
                    [aria-label]="'Remove value ' + value.name">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
      } @else {
      <!-- Empty State -->
      <mat-card class="content-card empty-state">
        <mat-card-content>
          <div class="empty-content">
            <mat-icon class="empty-icon">table_view</mat-icon>
            <h2>Select a Lookup Table</h2>
            <p>Choose a lookup table from the left panel to view and edit its values.</p>
          </div>
        </mat-card-content>
      </mat-card>
      }
    </div>
  </div>

  <!-- Popover Demo Section -->
  <div class="demo-section" style="margin-top: 24px; padding: 20px; border: 1px dashed var(--md-sys-color-outline, #79747e); border-radius: 12px;">
    <h3 style="margin: 0 0 16px 0; color: var(--md-sys-color-on-surface);">Popover Types Demo</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      <!-- External Popover Examples -->
      <div>
        <h4>External Popovers</h4>
        <p>Icons positioned outside form elements:</p>
        
        <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
          <mat-label>Standard Input</mat-label>
          <input matInput placeholder="Type something...">
          <button 
            mat-icon-button 
            matSuffix
            popoverTrigger="This is an external popover positioned outside the form field using matSuffix."
            [popoverConfig]="{ 
              placement: 'left', 
              showHeader: true, 
              headerText: 'External Help' 
            }">
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Inline Popover Examples -->
      <div>
        <h4>Inline Popovers</h4>
        <p>Icons positioned inside form elements:</p>
        
        <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
          <mat-label>Input with Inline Help</mat-label>
          <input 
            matInput 
            placeholder="Notice the help icon inside" />
          <button
            matSuffix
            mat-icon-button
            type="button"
            popoverTrigger="This shows help with Material's matSuffix approach:

• Icon positioned inside form field
• Professional Material Design styling  
• Built-in accessibility support
• Works with all form field types

This is the recommended approach!"
            [popoverConfig]="{
              placement: 'bottom-end',
              showHeader: true,
              headerText: 'Inline Help Demo'
            }"
            aria-label="Help with input"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field appearance="outline" style="width: 100%;">
          <mat-label>Textarea with Inline Help</mat-label>
          <textarea 
            matInput 
            rows="4"
            placeholder="This textarea has help in the top-right corner">
          </textarea>
          <button
            matSuffix
            mat-icon-button
            type="button"
            popoverTrigger="Textarea with inline help:

• Help icon positioned using matSuffix
• Clean, professional appearance
• Accessible by default
• Works with Material Design themes

Perfect for longer form descriptions!"
            [popoverConfig]="{
              placement: 'bottom-start',
              showHeader: true,
              headerText: 'Textarea Help'
            }"
            aria-label="Help with textarea"
          >
            <mat-icon>edit_note</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </div>
  </div>
</div>
