<mat-tab-group [selectedIndex]="selectedIndex()" (selectedIndexChange)="onTabChange($event)">
  <mat-tab *ngFor="let tab of tabConfigs(); let i = index" [disabled]="tab.enabled === false">
    <ng-template mat-tab-label>
      <span class="tab-label" [class.disabled-tab]="tab.enabled === false">
        <mat-icon class="tab-icon" *ngIf="tab.icon" [matTooltip]="tab.enabled === false ? (tab.disabledTooltip || 'Tab is disabled') : getTabTooltip(tab, i)">{{tab.icon}}</mat-icon>
        {{tab.label}}
        <mat-icon class="status-icon info-icon" *ngIf="tab.enabled === false" [matTooltip]="tab.disabledTooltip || 'Tab is disabled'">info</mat-icon>
        <mat-icon class="status-icon" *ngIf="tab.readOnly" [matTooltip]="'This tab is read-only'">visibility</mat-icon>
        <mat-icon class="status-icon" *ngIf="!tab.readOnly && states()[i]?.loaded && states()[i]?.valid" color="primary" [matTooltip]="'All data is valid'">check_circle</mat-icon>
        <mat-icon class="status-icon" *ngIf="!tab.readOnly && states()[i]?.loaded && !states()[i]?.valid" color="warn" [matTooltip]="'Please fix validation errors'">error</mat-icon>
        <mat-icon class="status-icon" *ngIf="tab.enabled !== false && !states()[i]?.loaded && loadingSet().has(i)" color="accent" [matTooltip]="'Loading content...'">hourglass_empty</mat-icon>
        <mat-icon class="status-icon" *ngIf="canShowClickToLoadIcon(tab, i)" [matTooltip]="getClickToLoadTooltip(tab, i)" [style.color]="getClickToLoadColor(tab, i)">{{getClickToLoadIcon(tab, i)}}</mat-icon>
      </span>
    </ng-template>

    <div class="per-tab-actions" *ngIf="tab.showPerTabActions && !tab.readOnly && states()[i]?.loaded">
      <button mat-button color="primary" (click)="saveTab(i)" [disabled]="!states()[i].valid">
        <mat-icon>save</mat-icon>Save
      </button>
      <button mat-button (click)="resetTab(i)" [disabled]="!states()[i].dirty">
        <mat-icon>refresh</mat-icon>Reset
      </button>
    </div>

    <ng-template #host></ng-template>

    <div class="spinner-wrap" *ngIf="tab.enabled !== false && loadingSet().has(i) && !states()[i]?.loaded">
      <mat-spinner diameter="32"></mat-spinner>
      <span>Loading {{tab.label.toLowerCase()}}â€¦</span>
    </div>
  </mat-tab>
</mat-tab-group>

<div class="global-actions" *ngIf="showGlobalActions()">
  <button mat-raised-button color="primary" (click)="saveAll()" [disabled]="!canSaveAll() && saveMode() === 'parent' && saveAllLoad() === 'none'">
    <mat-icon>save</mat-icon>
    {{ saveMode() === 'parent' ? 'Save All (Parent)' : 'Save All (Internal)'}}
  </button>
  <button mat-button (click)="resetAll()" [disabled]="!hasAnyLoaded()"><mat-icon>refresh</mat-icon>Reset All</button>
</div>
